document.addEventListener("DOMContentLoaded", () => {
  function decodeJWT(token) {
    try {
      const base64Url = token.split(".")[1];
      const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
      const jsonPayload = decodeURIComponent(
        atob(base64)
          .split("")
          .map((c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2))
          .join("")
      );
      return JSON.parse(jsonPayload);
    } catch (error) {
      console.error("Error decoding JWT:", error);
      return null;
    }
  }

  async function loginUser(event) {
    event.preventDefault();

    const userId = document.getElementById("userID").value;
    const password = document.getElementById("password").value;

    if (!userId || !password) {
      alert("Please enter your User ID and password.");
      return;
    }

    const loginData = { userID: userId, password };

    try {
      const response = await fetch("http://localhost:5000/api/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(loginData),
      });

      const data = await response.json();
      console.log("API response data:", data);

      if (response.ok) {
        alert("Login successful!");

        const token = data.token;
        console.log("Token received:", token);

        localStorage.setItem("authToken", token);

        const decodedToken = decodeJWT(token);
        console.log("Decoded token:", decodedToken);

        if (decodedToken && decodedToken.user && decodedToken.user.userID) {
          localStorage.setItem("userID", decodedToken.user.userID);
          console.log(
            "Saved userID to localStorage:",
            localStorage.getItem("userID")
          );
        } else {
          console.error("userID not found in decoded token.");
        }

        window.location.href = "../homePage/html_files/homePage.html";
        document.getElementById("login-form").reset();
      } else {
        alert(data.message || "Login failed.");
      }
    } catch (error) {
      console.error("Error during login:", error);
      alert("An error occurred during login. Please try again.");
    }
  }

  document.getElementById("login-form").addEventListener("submit", loginUser);
});
